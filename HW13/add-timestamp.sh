#!/bin/bash
# Скрипт для добавления условий к имени log и py файлов в заданном каталоге
# с копированием в другой заданный каталог
# Условие 1 - к имени log-файлов добавляется время создания
# Условие 2 - к имени py-файлов добавляется хэш последнего коммита

set -euo pipefail
src="$1"
dst="$2"

# Проверяем, что оба каталога указаны в аргументах
if [[ -z "$src" || -z "$dst" ]]; then
  echo "Используйте: $0 /исходный/каталог /каталог/назначения" >&2
  exit 2
fi

# Проверяем существование исходного каталога
if [ ! -d "$src" ]; then
  echo "Ошибка: каталог '$src' не существует."
  exit 1
fi

# Проверяем существование каталога назначения
if [ ! -d "$dst" ]; then
  echo "Ошибка: каталог '$dst' не существует."
  exit 1
fi

# Для определения хэша последнего коммита, запрашиваем каталог с локальным git-репозиторием
# и проверяем, что каталог является репозиторием
read -rp "Укажите путь к каталогу вашего git репозитория:" git_rep
if [ -d "$git_rep/.git" ] || [ -f "$git_rep/.git" ]; then
  echo "Указан корректный каталог репозитория"
else
  echo "Репозиторий не найден в каталоге $git_rep"
  exit 1
fi
cd "$git_rep"

# Определяем хэш последнего коммита
hash="$(git rev-parse HEAD)"

# Исключаем отсутствие файлов
shopt -s nullglob

# Перебираем все файлы в исходном каталоге
for f in "$src"/*; do
  
  # Убеждаемся что это обычный файл и он доступен для чтения
  if [[ ! -f "$f" ]]; then
    continue
  fi
  if [[ ! -r "$f" ]]; then
    printf 'Пропускаю (нет доступа на чтение): %s\n' "$f" >&2
    continue
  fi

# Делим имя файла на имя и расширение
  base=$(basename -- "$f")
  name="${base%.*}"
  ext="${base##*.}"

# Если файл имеет расширение .log, то добавляем к имени метку времени его изменения
  if [[ "$ext" == log ]]; then
    ts=$(date -r "$f" +"%Y%m%d_%H%M%S")
    newname="${name}_${ts}.${ext}"
    cp -- "$f" "$dst/$newname"  

# Если файл имеет расширение .py, то добавляем к имени хэш
  elif [[ "$ext" == py ]]; then
    newname="${name}_${hash}.${ext}"
    cp -- "$f" "$dst/$newname"
  fi
done
echo "Обработка файлов в каталоге $src закончена, файлы с расширениями .log и .py скопированы с новыми именами в каталог $dst"